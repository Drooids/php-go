#!/usr/bin/env php
<?php

use Herrera\Pake\Pake;
use Herrera\Service\Process\ProcessServiceProvider;

// workaround not being able to use __DIR__ in a closure
define('PAKE_DIR', dirname(__DIR__) . DIRECTORY_SEPARATOR);

call_user_func(function () {

    $composer = json_decode(file_get_contents(
        PAKE_DIR . "/composer.json"
    ), true);

    if (isset($composer['config']['vendor-dir'])) {
        $file = PAKE_DIR . $composer['config']['vendor-dir'] . '/autoload.php';
    } else {
        $file = PAKE_DIR . 'vendor/autoload.php';
    }

    if (file_exists($file)) {
        require($file);
    } else {
        echo "Unable to load Pake.\n";

        exit(1);
    }

    $app = new Pake('Pake', '@git_version@');
    $app->register(new ProcessServiceProvider());

    try {
    $app->load('Pakefile');

    } catch (Exception $exception) {
        $app['console']->renderException($exception, $app['console.output']);

        exit(1);
    }

    $app->run();
});
